<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoParts Pro | Tienda Oficial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .glass-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .hero-bg {
            background: linear-gradient(to right, #0f172a, #1e293b);
        }

        /* Toast Animation */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast {
            animation: slideIn 0.3s ease-out forwards;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800">

    <!-- NAVBAR -->
    <nav class="glass-nav fixed w-full z-50 border-b border-slate-200 shadow-sm top-0">
        <div class="container mx-auto px-4 h-20 flex items-center justify-between gap-8">
            <!-- Logo -->
            <a href="#" onclick="location.reload()" class="flex items-center gap-2 group">
                <div class="bg-blue-600 p-2 rounded-lg group-hover:bg-blue-700 transition-colors">
                    <i data-lucide="settings-2" class="text-white w-6 h-6"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-xl font-black leading-none text-slate-900">AUTOPARTS</span>
                    <span class="text-xs font-bold text-blue-600 tracking-widest">PRO STORE</span>
                </div>
            </a>

            <!-- Search -->
            <div class="hidden md:flex flex-1 max-w-xl relative">
                <input type="text" id="search-input" placeholder="Buscar repuesto (ej. Batería, Frenos)..."
                    class="w-full bg-slate-100 border-none rounded-full py-3 pl-12 pr-4 focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all outline-none font-medium">
                <i data-lucide="search" class="absolute left-4 top-3.5 text-slate-400 w-5 h-5"></i>
            </div>

            <!-- Actions -->
            <div class="flex items-center gap-4">
                <!-- Guest State -->
                <div id="auth-guest" class="flex items-center gap-2">
                    <button onclick="openModal('login')"
                        class="text-sm font-bold text-slate-600 hover:text-blue-600 px-4 py-2">Ingresar</button>
                    <button onclick="openModal('register')"
                        class="text-sm font-bold bg-slate-900 text-white px-5 py-2.5 rounded-full hover:bg-slate-800 transition-all shadow-lg shadow-slate-900/20">Registrarse</button>
                </div>

                <!-- Logged State -->
                <div id="auth-user" class="hidden items-center gap-4">
                    <div class="text-right hidden lg:block">
                        <p class="text-xs text-slate-500 font-medium">Bienvenido,</p>
                        <p class="text-sm font-bold text-slate-900" id="user-name-display">Usuario</p>
                    </div>
                    <button onclick="logout()" class="p-2 hover:bg-slate-100 rounded-full text-red-500"
                        title="Cerrar Sesión">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                </div>

                <div class="h-8 w-px bg-slate-200 mx-1"></div>

                <!-- Cart Trigger -->
                <button onclick="toggleCart()"
                    class="relative p-2 hover:bg-blue-50 rounded-full group transition-colors">
                    <i data-lucide="shopping-cart" class="w-6 h-6 text-slate-700 group-hover:text-blue-600"></i>
                    <span id="cart-badge"
                        class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-bold w-5 h-5 rounded-full flex items-center justify-center transform scale-0 transition-transform shadow-sm">0</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="pt-20">

        <!-- HERO SECTION -->
        <div class="hero-bg text-white py-20 relative overflow-hidden">
            <div
                class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]">
            </div>
            <div class="container mx-auto px-4 relative z-10 flex flex-col md:flex-row items-center">
                <div class="md:w-1/2 mb-10 md:mb-0">
                    <div
                        class="inline-block bg-blue-600/20 border border-blue-500/30 text-blue-300 text-xs font-bold px-3 py-1 rounded-full mb-4">
                        NUEVO STOCK 2025</div>
                    <h1 class="text-5xl md:text-6xl font-black mb-6 leading-tight">Repuestos Originales <br>al Mejor
                        Precio</h1>
                    <p class="text-slate-400 text-lg mb-8 max-w-md leading-relaxed">Expertos en mecánica confían en
                        nosotros. Envíos a todo el país en 24 horas.</p>
                    <button onclick="document.getElementById('catalog').scrollIntoView({behavior:'smooth'})"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-xl font-bold transition-all shadow-xl shadow-blue-600/30 flex items-center gap-2">
                        Ver Catálogo <i data-lucide="arrow-down" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="md:w-1/2 flex justify-center">
                    <img src="https://images.unsplash.com/photo-1486262715619-67b85e0b08d3?auto=format&fit=crop&w=800&q=80"
                        alt="Motor"
                        class="rounded-2xl shadow-2xl border-4 border-slate-700/50 w-4/5 transform rotate-3 hover:rotate-0 transition-transform duration-500">
                </div>
            </div>
        </div>

        <!-- CATALOG SECTION -->
        <section id="catalog" class="py-16 bg-slate-50">
            <div class="container mx-auto px-4">
                <div class="flex flex-col md:flex-row justify-between items-end mb-10 gap-4">
                    <div>
                        <h2 class="text-3xl font-black text-slate-900">Catálogo de Productos</h2>
                        <p class="text-slate-500 mt-2">Explora por categoría o busca tu repuesto específico.</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="fetchProducts('Frenos')"
                            class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-medium hover:border-blue-500 hover:text-blue-600 transition-colors">Frenos</button>
                        <button onclick="fetchProducts('Motor')"
                            class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-medium hover:border-blue-500 hover:text-blue-600 transition-colors">Motor</button>
                        <button onclick="fetchProducts('Eléctrico')"
                            class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-medium hover:border-blue-500 hover:text-blue-600 transition-colors">Eléctrico</button>
                        <button onclick="fetchProducts()"
                            class="px-4 py-2 bg-slate-900 text-white rounded-lg text-sm font-medium hover:bg-slate-800 transition-colors">Ver
                            Todo</button>
                    </div>
                </div>

                <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                    <!-- JS Injection Point -->
                    <div class="col-span-full py-20 text-center">
                        <div
                            class="inline-block animate-spin w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full mb-4">
                        </div>
                        <p class="text-slate-500 font-medium">Cargando inventario...</p>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- FOOTER -->
    <footer class="bg-slate-900 text-slate-400 py-12">
        <div class="container mx-auto px-4 text-center">
            <div class="flex items-center justify-center gap-2 mb-6">
                <i data-lucide="settings-2" class="text-blue-600"></i>
                <span class="text-xl font-black text-white">AUTOPARTS PRO</span>
            </div>
            <p class="text-sm">© 2025 Sistema de E-commerce Distribuido. Proyecto Universitario.</p>
        </div>
    </footer>

    <!-- CART SIDEBAR (OFF-CANVAS) -->
    <div id="cart-sidebar" class="fixed inset-0 z-[60] pointer-events-none">
        <!-- Backdrop -->
        <div id="cart-backdrop" onclick="toggleCart()"
            class="absolute inset-0 bg-black/40 backdrop-blur-sm opacity-0 transition-opacity duration-300 pointer-events-auto hidden">
        </div>

        <!-- Panel -->
        <div id="cart-panel"
            class="absolute top-0 right-0 h-full w-full max-w-md bg-white shadow-2xl transform translate-x-full transition-transform duration-300 flex flex-col pointer-events-auto">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h2 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                    <i data-lucide="shopping-bag" class="w-5 h-5 text-blue-600"></i> Tu Carrito
                </h2>
                <button onclick="toggleCart()" class="text-slate-400 hover:text-red-500 transition-colors"><i
                        data-lucide="x" class="w-6 h-6"></i></button>
            </div>

            <div id="cart-items" class="flex-1 overflow-y-auto p-6 space-y-4">
                <!-- Items go here -->
            </div>

            <div class="p-6 border-t border-slate-100 bg-slate-50">
                <div class="flex justify-between items-end mb-4">
                    <span class="text-slate-500 font-medium">Total Estimado</span>
                    <span id="cart-total" class="text-2xl font-black text-slate-900">$0.00</span>
                </div>
                <button onclick="checkout()"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-600/20 transition-all flex items-center justify-center gap-2">
                    Proceder al Pago <i data-lucide="arrow-right" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- AUTH MODAL -->
    <div id="auth-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal()"></div>
        <div
            class="bg-white rounded-2xl shadow-2xl w-full max-w-md relative z-10 overflow-hidden animate-[fadeIn_0.2s_ease-out]">
            <!-- Tabs -->
            <div class="flex border-b border-slate-100">
                <button onclick="switchAuth('login')" id="tab-login"
                    class="flex-1 py-4 font-bold text-blue-600 border-b-2 border-blue-600 bg-blue-50 transition-all">Iniciar
                    Sesión</button>
                <button onclick="switchAuth('register')" id="tab-register"
                    class="flex-1 py-4 font-bold text-slate-400 hover:text-slate-600 hover:bg-slate-50 transition-all">Crear
                    Cuenta</button>
            </div>

            <div class="p-8">
                <!-- LOGIN FORM -->
                <form id="form-login" onsubmit="handleLogin(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Correo Electrónico</label>
                        <input type="email" name="email" required
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-medium">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Contraseña</label>
                        <input type="password" name="password" required
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-medium">
                    </div>
                    <button type="submit"
                        class="w-full bg-slate-900 text-white py-3 rounded-lg font-bold hover:bg-blue-600 transition-colors">Entrar</button>
                </form>

                <!-- REGISTER FORM -->
                <form id="form-register" onsubmit="handleRegister(event)" class="space-y-4 hidden">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" name="firstName" placeholder="Nombre" required
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        <input type="text" name="lastName" placeholder="Apellido" required
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <input type="email" name="email" placeholder="Correo Electrónico" required
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    <input type="password" name="password" placeholder="Contraseña" required
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    <input type="text" name="address" placeholder="Dirección de Envío" required
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    <button type="submit"
                        class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors">Registrarse</button>
                </form>
            </div>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-[80] flex flex-col gap-3"></div>

    <script>
        // --- CONFIGURACIÓN ---
        const API_URL = 'http://localhost:3010';
        const state = {
            user: JSON.parse(localStorage.getItem('client_user')) || null,
            token: localStorage.getItem('client_token') || null,
            cart: JSON.parse(localStorage.getItem('client_cart')) || [],
            products: []
        };

        // --- INIT ---
        window.onload = () => {
            lucide.createIcons();
            updateAuthUI();
            updateCartUI();
            fetchProducts();
        };

        // --- TOAST SYSTEM ---
        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = type === 'success' ? 'bg-green-600' : 'bg-red-600';
            toast.className = `toast ${colors} text-white px-6 py-4 rounded-xl shadow-xl flex items-center gap-3 font-medium min-w-[300px]`;
            toast.innerHTML = `<i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-5 h-5"></i> ${msg}`;
            container.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => toast.remove(), 3000);
        }

        // --- CATALOG LOGIC ---
        async function fetchProducts(category = null) {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = `<div class="col-span-full text-center py-20"><div class="inline-block animate-spin w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full"></div></div>`;

            try {
                let url = `${API_URL}/catalog/products`;
                if (category) url += `?category=${category}`;

                const res = await fetch(url);
                if (!res.ok) throw new Error('Error al conectar con Microservicio Catálogo');

                const products = await res.json();
                state.products = products;
                renderProducts(products);

            } catch (error) {
                console.error(error);
                // FALLBACK DEMO (Por si el backend falla en la presentación)
                const demoData = [
                    { id: 1, name: "Kit de Frenos Cerámicos", price: 120.00, sku: "BRK-001", category: "Frenos", description: "Alto rendimiento y durabilidad.", image_url: "https://images.unsplash.com/photo-1661331771971-5507945db594?w=400" },
                    { id: 2, name: "Batería 12V Premium", price: 150.50, sku: "BAT-009", category: "Eléctrico", description: "Garantía de 24 meses.", image_url: "https://images.unsplash.com/photo-1623126908029-58cb08a2b272?w=400" },
                    { id: 3, name: "Aceite Sintético 5W-30", price: 45.00, sku: "OIL-530", category: "Motor", description: "Protección total para tu motor.", image_url: "https://images.unsplash.com/photo-1594950965823-74b868664157?w=400" }
                ];
                state.products = demoData;
                renderProducts(demoData);
                showToast('Modo DEMO (Backend desconectado)', 'error');
            }
        }

        function renderProducts(products) {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = '';

            if (products.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center text-slate-500 py-10">No hay productos en esta categoría.</div>`;
                return;
            }

            products.forEach(p => {
                const card = document.createElement('div');
                card.className = "bg-white rounded-2xl border border-slate-100 overflow-hidden hover:shadow-xl transition-all duration-300 group";
                card.innerHTML = `
                    <div class="h-56 overflow-hidden relative bg-slate-100">
                        <img src="${p.image_url || 'https://via.placeholder.com/400?text=No+Image'}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                        <div class="absolute top-3 left-3 bg-white/90 backdrop-blur px-3 py-1 rounded-full text-xs font-bold text-slate-900 uppercase tracking-wider">
                            ${p.category || 'Repuesto'}
                        </div>
                    </div>
                    <div class="p-6">
                        <h3 class="font-bold text-lg text-slate-900 mb-1 truncate">${p.name}</h3>
                        <p class="text-slate-500 text-sm mb-4 h-10 line-clamp-2">${p.description || 'Sin descripción disponible.'}</p>
                        <div class="flex items-center justify-between mt-4">
                            <div class="flex flex-col">
                                <span class="text-xs text-slate-400 font-medium">Precio</span>
                                <span class="text-2xl font-black text-blue-600">$${parseFloat(p.price).toFixed(2)}</span>
                            </div>
                            <button onclick="addToCart(${p.id})" class="bg-slate-900 text-white w-10 h-10 rounded-lg flex items-center justify-center hover:bg-blue-600 transition-colors shadow-lg shadow-slate-900/20">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            lucide.createIcons();
        }

        // --- CART LOGIC ---
        function addToCart(id) {
            const product = state.products.find(p => p.id === id);
            if (!product) return;

            const existing = state.cart.find(item => item.id === id);
            if (existing) existing.quantity++;
            else state.cart.push({ ...product, quantity: 1 });

            saveCart();
            showToast(`${product.name} agregado`);
            // NO abrir el carrito automáticamente (fix solicitado)
            updateCartUI();
        }

        function saveCart() {
            localStorage.setItem('client_cart', JSON.stringify(state.cart));
            updateCartUI();
        }

        function toggleCart() {
            const panel = document.getElementById('cart-panel');
            const backdrop = document.getElementById('cart-backdrop');
            const isOpen = !panel.classList.contains('translate-x-full');

            if (isOpen) {
                panel.classList.add('translate-x-full');
                backdrop.classList.add('opacity-0');
                setTimeout(() => {
                    backdrop.classList.add('hidden');
                }, 300);
            } else {
                backdrop.classList.remove('hidden');
                requestAnimationFrame(() => {
                    backdrop.classList.remove('opacity-0');
                    panel.classList.remove('translate-x-full');
                });
            }
        }

        function updateCartUI() {
            const badge = document.getElementById('cart-badge');
            const container = document.getElementById('cart-items');
            const totalEl = document.getElementById('cart-total');

            const count = state.cart.reduce((acc, item) => acc + item.quantity, 0);
            badge.textContent = count;
            badge.classList.toggle('scale-0', count === 0);

            let total = 0;
            container.innerHTML = '';

            if (state.cart.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-slate-400">
                        <i data-lucide="shopping-cart" class="w-12 h-12 mb-4 opacity-20"></i>
                        <p class="font-medium">Tu carrito está vacío</p>
                    </div>`;
            } else {
                state.cart.forEach((item, idx) => {
                    total += item.price * item.quantity;
                    const row = document.createElement('div');
                    row.className = "flex gap-4 items-center bg-slate-50 p-3 rounded-xl";
                    row.innerHTML = `
                        <img src="${item.image_url}" class="w-16 h-16 rounded-lg object-cover bg-white border border-slate-100">
                        <div class="flex-1">
                            <h4 class="font-bold text-sm text-slate-900 line-clamp-1">${item.name}</h4>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs font-bold text-blue-600">$${item.price}</span>
                                <span class="text-xs text-slate-400">x${item.quantity}</span>
                            </div>
                        </div>
                        <button onclick="removeFromCart(${idx})" class="text-slate-400 hover:text-red-500 transition-colors p-2">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    `;
                    container.appendChild(row);
                });
            }
            totalEl.textContent = `$${total.toFixed(2)}`;
            lucide.createIcons();
        }

        function removeFromCart(idx) {
            state.cart.splice(idx, 1);
            saveCart();
        }

        async function checkout() {
            if (state.cart.length === 0) return;
            if (!state.user) {
                toggleCart();
                openModal('login');
                showToast('Inicia sesión para finalizar la compra', 'error');
                return;
            }

            try {
                const orderData = {
                    user_id: state.user.id || 1, // Fallback para demo
                    items: state.cart.map(i => ({ product_id: i.id, quantity: i.quantity }))
                };

                const res = await fetch(`${API_URL}/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                if (res.ok) {
                    state.cart = [];
                    saveCart();
                    toggleCart();
                    showToast('¡Compra exitosa! Gracias por tu preferencia.');
                } else {
                    throw new Error('Error procesando orden');
                }
            } catch (e) {
                console.error(e);
                showToast('Error procesando orden (Backend no respondió)', 'error');
            }
        }

        // --- AUTH LOGIC ---
        function openModal(tab) {
            document.getElementById('auth-modal').classList.remove('hidden');
            switchAuth(tab);
        }
        function closeModal() {
            document.getElementById('auth-modal').classList.add('hidden');
        }
        function switchAuth(tab) {
            const loginForm = document.getElementById('form-login');
            const regForm = document.getElementById('form-register');
            const loginTab = document.getElementById('tab-login');
            const regTab = document.getElementById('tab-register');

            if (tab === 'login') {
                loginForm.classList.remove('hidden');
                regForm.classList.add('hidden');
                loginTab.classList.add('text-blue-600', 'border-blue-600');
                loginTab.classList.remove('text-slate-400');
                regTab.classList.remove('text-blue-600', 'border-blue-600');
                regTab.classList.add('text-slate-400');
            } else {
                loginForm.classList.add('hidden');
                regForm.classList.remove('hidden');
                regTab.classList.add('text-blue-600', 'border-blue-600');
                regTab.classList.remove('text-slate-400');
                loginTab.classList.remove('text-blue-600', 'border-blue-600');
                loginTab.classList.add('text-slate-400');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = e.target.email.value;
            // Auth Simulation (replace with fetch to /auth/login)
            state.user = { name: email.split('@')[0], email };
            localStorage.setItem('client_user', JSON.stringify(state.user));
            closeModal();
            updateAuthUI();
            showToast('Bienvenido de nuevo');
        }

        async function handleRegister(e) {
            e.preventDefault();
            // Register Simulation
            const data = Object.fromEntries(new FormData(e.target));
            state.user = { name: data.firstName, email: data.email };
            localStorage.setItem('client_user', JSON.stringify(state.user));
            closeModal();
            updateAuthUI();
            showToast('Cuenta creada correctamente');
        }

        function logout() {
            state.user = null;
            localStorage.removeItem('client_user');
            updateAuthUI();
            showToast('Sesión cerrada');
        }

        function updateAuthUI() {
            const guest = document.getElementById('auth-guest');
            const user = document.getElementById('auth-user');

            if (state.user) {
                guest.classList.add('hidden');
                user.classList.remove('hidden');
                user.classList.add('flex');
                document.getElementById('user-name-display').textContent = state.user.name;
            } else {
                guest.classList.remove('hidden');
                user.classList.add('hidden');
                user.classList.remove('flex');
            }
        }
    </script>
</body>

</html>
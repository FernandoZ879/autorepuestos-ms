<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | AutoParts Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-overlay { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); }
        @keyframes slideIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-content { animation: slideIn 0.2s ease-out; }
    </style>
</head>

<body class="bg-slate-100 h-screen flex overflow-hidden">

    <!-- LOGIN OVERLAY -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-slate-900 flex items-center justify-center">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center modal-content">
            <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="shield-check" class="w-8 h-8 text-blue-600"></i>
            </div>
            <h1 class="text-2xl font-black text-slate-900 mb-2">Acceso Administrativo</h1>
            <p class="text-slate-500 mb-6 text-sm">Sistema restringido a personal autorizado.</p>
            <form onsubmit="handleAdminLogin(event)" class="space-y-4">
                <input type="email" id="admin-email" placeholder="admin@autoparts.com" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                <input type="password" id="admin-password" placeholder="••••••••" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                <button type="submit" class="w-full bg-slate-900 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition-colors shadow-lg">Ingresar</button>
            </form>
        </div>
    </div>

    <!-- SIDEBAR -->
    <aside class="w-64 bg-slate-900 text-white flex flex-col flex-shrink-0 transition-all duration-300">
        <div class="h-20 flex items-center px-6 border-b border-slate-800">
            <i data-lucide="settings-2" class="w-6 h-6 text-blue-500 mr-3"></i>
            <span class="font-bold text-lg tracking-wide">AutoParts<span class="text-blue-500">Admin</span></span>
        </div>
        <nav class="flex-1 py-6 space-y-1 px-3">
            <a href="#" onclick="nav('dashboard')" id="nav-dashboard" class="flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-colors group active-nav bg-slate-800 text-white">
                <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3 group-hover:text-blue-400"></i> Dashboard
            </a>
            <a href="#" onclick="nav('inventory')" id="nav-inventory" class="flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-colors group">
                <i data-lucide="box" class="w-5 h-5 mr-3 group-hover:text-blue-400"></i> Inventario
            </a>
            <a href="#" onclick="nav('products')" id="nav-products" class="flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-colors group">
                <i data-lucide="package" class="w-5 h-5 mr-3 group-hover:text-blue-400"></i> Productos
            </a>
            <a href="#" onclick="nav('categories')" id="nav-categories" class="flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-colors group">
                <i data-lucide="tag" class="w-5 h-5 mr-3 group-hover:text-blue-400"></i> Categorías
            </a>
            <a href="#" onclick="nav('stores')" id="nav-stores" class="flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-colors group">
                <i data-lucide="store" class="w-5 h-5 mr-3 group-hover:text-blue-400"></i> Tiendas
            </a>
            <a href="#" onclick="nav('orders')" id="nav-orders" class="flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-colors group">
                <i data-lucide="shopping-cart" class="w-5 h-5 mr-3 group-hover:text-blue-400"></i> Pedidos
            </a>
             <a href="#" onclick="nav('customers')" id="nav-customers" class="flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition-colors group">
                <i data-lucide="users" class="w-5 h-5 mr-3 group-hover:text-blue-400"></i> Clientes
            </a>
        </nav>
        <div class="p-4 border-t border-slate-800">
            <button onclick="adminLogout()" class="flex items-center justify-center w-full px-4 py-2 text-sm text-slate-400 hover:text-white hover:bg-red-900/30 rounded-lg transition-colors">
                <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Cerrar Sesión
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col overflow-hidden relative">
        <header class="h-20 bg-white border-b border-slate-200 flex items-center justify-between px-8">
            <h2 id="page-title" class="text-2xl font-bold text-slate-800">Dashboard General</h2>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <p class="text-sm font-bold text-slate-900">Administrador</p>
                    <p class="text-xs text-slate-500">Acceso Total</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold">AD</div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8">
            <!-- DASHBOARD -->
            <div id="view-dashboard" class="view-section space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <p class="text-xs font-bold text-slate-500 uppercase">Productos</p>
                        <h3 id="stat-products" class="text-3xl font-black text-slate-900 mt-2">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <p class="text-xs font-bold text-slate-500 uppercase">Ventas Totales</p>
                        <h3 class="text-3xl font-black text-slate-900 mt-2">$0.00</h3>
                    </div>
                </div>
            </div>

            <!-- PRODUCTS -->
            <div id="view-products" class="view-section hidden space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-center">
                        <div class="flex gap-4">
                            <input type="text" id="search-products" placeholder="Buscar..." class="px-4 py-2 border rounded-lg">
                            <button onclick="openExcelImport()" class="px-4 py-2 bg-green-600 text-white rounded-lg flex items-center gap-2"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Importar</button>
                        </div>
                        <button onclick="openProductModal(null)" class="px-4 py-2 bg-blue-600 text-white rounded-lg flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Nuevo Producto</button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 border-b">
                            <tr>
                                <th class="px-6 py-4">Imagen</th>
                                <th class="px-6 py-4">Nombre</th>
                                <th class="px-6 py-4">SKU</th>
                                <th class="px-6 py-4">Categoría</th>
                                <th class="px-6 py-4">Precio</th>
                                <th class="px-6 py-4">Stock</th>
                                <th class="px-6 py-4 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <!-- CATEGORIES -->
            <div id="view-categories" class="view-section hidden space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex justify-between">
                    <h3 class="text-xl font-bold">Categorías</h3>
                    <button onclick="openCategoryModal(null)" class="px-4 py-2 bg-blue-600 text-white rounded-lg flex gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Nueva</button>
                </div>
                <div id="categories-grid" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            </div>

            <!-- STORES -->
            <div id="view-stores" class="view-section hidden space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex justify-between">
                    <h3 class="text-xl font-bold">Tiendas</h3>
                    <button onclick="openStoreModal(null)" class="px-4 py-2 bg-blue-600 text-white rounded-lg flex gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Nueva</button>
                </div>
                <div id="stores-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </div>

            <!-- INVENTORY -->
            <div id="view-inventory" class="view-section hidden space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-bold mb-4">Stock por Tienda</h3>
                    <div id="inventory-matrix"></div>
                </div>
            </div>
            
             <!-- ORDERS -->
            <div id="view-orders" class="view-section hidden space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-bold mb-4">Pedidos Recientes</h3>
                    <div id="orders-list"></div>
                </div>
            </div>

            <!-- CUSTOMERS -->
            <div id="view-customers" class="view-section hidden space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-bold mb-4">Base de Datos de Clientes</h3>
                    <div id="customers-list"></div>
                </div>
            </div>

        </div>
    </main>

    <!-- PRODUCT MODAL -->
    <div id="product-modal" class="fixed inset-0 z-[100] hidden items-center justify-center px-4 modal-overlay">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto modal-content">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 id="product-modal-title" class="text-xl font-bold">Producto</h3>
                <button onclick="closeProductModal()"><i data-lucide="x"></i></button>
            </div>
            <form id="product-form" class="p-6 space-y-4">
                <input type="hidden" id="product-id">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="product-name" placeholder="Nombre" required class="border p-2 rounded w-full">
                    <input type="text" id="product-sku" placeholder="SKU" required class="border p-2 rounded w-full">
                </div>
                <textarea id="product-description" placeholder="Descripción" class="border p-2 rounded w-full"></textarea>
                <div class="grid grid-cols-3 gap-4">
                    <input type="number" id="product-price" step="0.01" placeholder="Precio" required class="border p-2 rounded w-full">
                    <input type="number" id="product-stock" placeholder="Stock Inicial" class="border p-2 rounded w-full">
                    <select id="product-category" required class="border p-2 rounded w-full"></select>
                </div>
                <input type="url" id="product-image" placeholder="URL Imagen (Opcional)" class="border p-2 rounded w-full">
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded font-bold">Guardar</button>
            </form>
        </div>
    </div>

    <!-- CATEGORY MODAL -->
    <div id="category-modal" class="fixed inset-0 z-[100] hidden items-center justify-center px-4 modal-overlay">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md modal-content">
            <form id="category-form" class="p-6 space-y-4">
                <h3 class="text-xl font-bold">Nueva Categoría</h3>
                <input type="text" id="category-name" placeholder="Nombre" required class="border p-2 rounded w-full">
                <textarea id="category-description" placeholder="Descripción" class="border p-2 rounded w-full"></textarea>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">Guardar</button>
                <button type="button" onclick="closeCategoryModal()" class="w-full bg-slate-200 py-2 rounded">Cancelar</button>
            </form>
        </div>
    </div>

    <!-- STORE MODAL -->
    <div id="store-modal" class="fixed inset-0 z-[100] hidden items-center justify-center px-4 modal-overlay">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md modal-content">
            <form id="store-form" class="p-6 space-y-4">
                <h3 class="text-xl font-bold">Nueva Tienda</h3>
                <input type="text" id="store-name" placeholder="Nombre" required class="border p-2 rounded w-full">
                <input type="text" id="store-nit" placeholder="NIT" required class="border p-2 rounded w-full">
                <input type="text" id="store-address" placeholder="Dirección" required class="border p-2 rounded w-full">
                <input type="tel" id="store-phone" placeholder="Teléfono" required class="border p-2 rounded w-full">
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded">Guardar</button>
                <button type="button" onclick="closeStoreModal()" class="w-full bg-slate-200 py-2 rounded">Cancelar</button>
            </form>
        </div>
    </div>

    <!-- EXCEL IMPORT MODAL -->
    <div id="excel-modal" class="fixed inset-0 z-[100] hidden items-center justify-center px-4 modal-overlay">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl modal-content p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Importar Excel</h3>
                <button onclick="downloadTemplate()" class="text-blue-600 text-sm underline hover:text-blue-800">Descargar Plantilla</button>
            </div>
            <input type="file" id="excel-file" onchange="handleExcelUpload(event)" accept=".xlsx,.xls" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
            <div id="import-preview" class="mt-4 hidden">
                <div id="json-preview-content" class="bg-slate-50 p-4 h-40 overflow-auto text-xs font-mono border rounded mb-4"></div>
                <button onclick="processImport()" class="w-full bg-green-600 text-white py-3 rounded font-bold">Confirmar Importación</button>
            </div>
             <button onclick="closeExcelModal()" class="mt-2 text-red-500 text-sm">Cerrar</button>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3010';
        let importedData = [];

        window.onload = () => {
            lucide.createIcons();
            if(localStorage.getItem('admin_token')) {
                document.getElementById('login-screen').classList.add('hidden');
                initDashboard();
            }
        };

        function handleAdminLogin(e) {
            e.preventDefault();
            if(document.getElementById('admin-email').value === 'admin@autoparts.com') {
                localStorage.setItem('admin_token', '123');
                location.reload();
            }
        }
        function adminLogout() { localStorage.removeItem('admin_token'); location.reload(); }

        function nav(view) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');
            if(view === 'products') loadProducts();
            if(view === 'categories') loadCategories();
            if(view === 'stores') loadStores();
            if(view === 'inventory') loadInventoryMatrix();
            if(view === 'orders') loadOrders();
            if(view === 'customers') loadCustomers();
        }

        // --- HELPERS ---
        async function getStores() {
            const res = await fetch(`${API_URL}/inventory/stores`);
            return await res.json();
        }
        
        async function getOrCreateDefaultStore() {
            let stores = await getStores();
            if (stores.length === 0) {
                const res = await fetch(`${API_URL}/inventory/stores`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name: 'Almacén Principal', nit: '1000', address: 'Central', phone: '000'})
                });
                const newStore = await res.json();
                return newStore.id;
            }
            return stores[0].id;
        }
        
        function downloadTemplate() {
            const data = [
                { Nombre: 'Ejemplo Batería', Descripcion: 'Batería 12V', Precio: 150, SKU: 'BAT-001', Categoria: 'Electrico', Imagen: '', Stock: 10 },
                { Nombre: 'Ejemplo Freno', Descripcion: 'Pastillas de freno', Precio: 50, SKU: 'BRK-002', Categoria: 'Frenos', Imagen: '', Stock: 20 }
            ];
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Template");
            XLSX.writeFile(wb, "template_productos.xlsx");
        }

        // --- PRODUCTS ---
        async function loadProducts() {
            const tbody = document.getElementById('products-table-body');
            tbody.innerHTML = '<tr><td colspan="7">Cargando...</td></tr>';
            
            const [products, stocks] = await Promise.all([
                fetch(`${API_URL}/catalog/products`).then(r => r.json()),
                fetch(`${API_URL}/inventory/stock`).then(r => r.json())
            ]);
            
            await loadCategoriesDropdown();

            tbody.innerHTML = products.map(p => {
                const productStock = stocks
                    .filter(s => s.product_id === p.id)
                    .reduce((sum, s) => sum + s.quantity, 0);
                
                // Placeholder logic
                const img = (p.image_url && p.image_url !== 'placeholder.png') ? p.image_url : 'placeholder.png';
                
                return `
                    <tr class="hover:bg-slate-50">
                        <td class="p-4"><img src="${img}" class="w-12 h-12 object-cover rounded bg-slate-200" onerror="this.src='placeholder.png'"></td>
                        <td class="p-4 font-medium">${p.name}</td>
                        <td class="p-4 text-slate-500 text-xs font-mono">${p.sku || '-'}</td>
                        <td class="p-4"><span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${p.category || 'N/A'}</span></td>
                        <td class="p-4 font-bold">$${parseFloat(p.price).toFixed(2)}</td>
                        <td class="p-4"><span class="font-bold ${productStock < 5 ? 'text-red-600' : 'text-green-600'}">${productStock}</span></td>
                        <td class="p-4 text-right">
                            <button onclick="deleteProduct('${p.id}')" class="text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
            lucide.createIcons();
            document.getElementById('stat-products').textContent = products.length;
        }

        async function loadCategoriesDropdown() {
            try {
                const res = await fetch(`${API_URL}/catalog/categories`);
                const categories = await res.json();
                const select = document.getElementById('product-category');
                select.innerHTML = '<option value="">Seleccionar Categoría</option>' + 
                    categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            } catch (e) { console.error("Error loading categories", e); }
        }

        // --- SAVE PRODUCT (CHAINED) ---
        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const imgInput = document.getElementById('product-image').value;
            const image_url = imgInput.trim() === '' ? 'placeholder.png' : imgInput;

            const data = {
                name: document.getElementById('product-name').value,
                sku: document.getElementById('product-sku').value,
                description: document.getElementById('product-description').value,
                price: parseFloat(document.getElementById('product-price').value),
                category: document.getElementById('product-category').value,
                image_url: image_url
            };
            const initialStock = parseInt(document.getElementById('product-stock').value) || 0;

            try {
                const res = await fetch(`${API_URL}/catalog/products`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (!res.ok) throw new Error('Error al crear producto');
                const product = await res.json();

                if (initialStock > 0) {
                    const storeId = await getOrCreateDefaultStore();
                    await fetch(`${API_URL}/inventory/stock`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ productId: product.id, storeId, quantity: initialStock })
                    });
                }

                alert('Producto guardado correctamente');
                closeProductModal();
                loadProducts();
            } catch (err) {
                alert(err.message);
            }
        });

        // --- EXCEL IMPORT (CHAINED) ---
        async function processImport() {
            if (importedData.length === 0) return;
            let count = 0;
            const storeId = await getOrCreateDefaultStore();

            for (const item of importedData) {
                try {
                    let img = item.image_url || item.Imagen || '';
                    if (!img || img.trim() === '') img = 'placeholder.png';

                    const payload = {
                        name: item.name || item.Nombre,
                        description: item.description || item.Descripcion,
                        price: item.price || item.Precio,
                        sku: item.sku || item.SKU || `GEN-${Math.floor(Math.random()*100000)}`,
                        category: item.category || item.Categoria || 'General',
                        image_url: img
                    };
                    
                    const res = await fetch(`${API_URL}/catalog/products`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
                    });
                    if(res.ok) {
                        const prod = await res.json();
                        const stock = item.stock || item.Stock || 0;
                        if(stock > 0) {
                            await fetch(`${API_URL}/inventory/stock`, {
                                method: 'POST', headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({ productId: prod.id, storeId, quantity: stock })
                            });
                        }
                        count++;
                    }
                } catch (e) { console.error(e); }
            }
            alert(`Importados ${count} productos`);
            closeExcelModal();
            loadProducts();
        }

        // --- CATEGORIES ---
        async function loadCategories() {
            try {
                const res = await fetch(`${API_URL}/catalog/categories`);
                const cats = await res.json();
                document.getElementById('categories-grid').innerHTML = cats.map(c => `
                    <div class="bg-white p-4 rounded shadow border">
                        <h4 class="font-bold">${c.name}</h4>
                        <p class="text-sm text-slate-500">${c.description || ''}</p>
                        <button onclick="deleteCategory('${c.id}')" class="text-red-500 text-xs mt-2">Eliminar</button>
                    </div>
                `).join('');
            } catch (e) {
                document.getElementById('categories-grid').innerHTML = '<p>Error cargando categorías</p>';
            }
        }
        
        document.getElementById('category-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await fetch(`${API_URL}/catalog/categories`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: document.getElementById('category-name').value,
                    description: document.getElementById('category-description').value
                })
            });
            closeCategoryModal();
            loadCategories();
        });
        
        async function deleteCategory(id) {
            if(confirm('Eliminar?')) {
                await fetch(`${API_URL}/catalog/categories/${id}`, { method: 'DELETE' });
                loadCategories();
            }
        }

        // --- STORES ---
        async function loadStores() {
            try {
                const stores = await getStores();
                document.getElementById('stores-grid').innerHTML = stores.map(s => `
                    <div class="bg-white p-4 rounded shadow border">
                        <h4 class="font-bold">${s.name}</h4>
                        <p class="text-xs">NIT: ${s.nit}</p>
                        <p class="text-xs">${s.address}</p>
                    </div>
                `).join('');
            } catch(e) {
                 document.getElementById('stores-grid').innerHTML = '<p>Error cargando tiendas</p>';
            }
        }

        document.getElementById('store-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await fetch(`${API_URL}/inventory/stores`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: document.getElementById('store-name').value,
                    nit: document.getElementById('store-nit').value,
                    address: document.getElementById('store-address').value,
                    phone: document.getElementById('store-phone').value
                })
            });
            closeStoreModal();
            loadStores();
        });

        // --- CUSTOMERS ---
        async function loadCustomers() {
            const container = document.getElementById('customers-list');
            container.innerHTML = '<p>Cargando clientes...</p>';
            try {
                const res = await fetch(`${API_URL}/auth/users`);
                const users = await res.json();
                
                if(users.length === 0) {
                     container.innerHTML = '<p>No hay clientes registrados.</p>';
                     return;
                }

                let html = `<table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 border-b"><tr>
                        <th class="p-4">Nombre</th>
                        <th class="p-4">Email</th>
                        <th class="p-4">Rol</th>
                        <th class="p-4">Teléfono</th>
                        <th class="p-4">Registrado</th>
                    </tr></thead><tbody>`;
                
                users.forEach(u => {
                    html += `<tr class="border-b hover:bg-slate-50">
                        <td class="p-4 font-bold">${u.name}</td>
                        <td class="p-4">${u.email}</td>
                        <td class="p-4"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">${u.role}</span></td>
                        <td class="p-4">${u.phone || '-'}</td>
                        <td class="p-4">${new Date(u.created_at).toLocaleDateString()}</td>
                    </tr>`;
                });
                html += `</tbody></table>`;
                container.innerHTML = html;

            } catch (e) {
                container.innerHTML = '<p class="text-red-500">Error cargando clientes. Verifica el servicio de Auth.</p>';
            }
        }

        // --- MODALS & UTILS ---
        function openProductModal() { document.getElementById('product-modal').classList.remove('hidden'); document.getElementById('product-modal').classList.add('flex'); loadCategoriesDropdown(); }
        function closeProductModal() { document.getElementById('product-modal').classList.add('hidden'); document.getElementById('product-modal').classList.remove('flex'); }
        function openCategoryModal() { document.getElementById('category-modal').classList.remove('hidden'); document.getElementById('category-modal').classList.add('flex'); }
        function closeCategoryModal() { document.getElementById('category-modal').classList.add('hidden'); document.getElementById('category-modal').classList.remove('flex'); }
        function openStoreModal() { document.getElementById('store-modal').classList.remove('hidden'); document.getElementById('store-modal').classList.add('flex'); }
        function closeStoreModal() { document.getElementById('store-modal').classList.add('hidden'); document.getElementById('store-modal').classList.remove('flex'); }
        function openExcelImport() { document.getElementById('excel-modal').classList.remove('hidden'); document.getElementById('excel-modal').classList.add('flex'); }
        function closeExcelModal() { document.getElementById('excel-modal').classList.add('hidden'); document.getElementById('excel-modal').classList.remove('flex'); }
        function handleExcelUpload(e) {
             const file = e.target.files[0];
             const reader = new FileReader();
             reader.onload = (evt) => {
                 const wb = XLSX.read(new Uint8Array(evt.target.result), {type:'array'});
                 importedData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                 document.getElementById('import-preview').classList.remove('hidden');
                 document.getElementById('json-preview-content').textContent = JSON.stringify(importedData,null,2);
             };
             reader.readAsArrayBuffer(file);
        }
        async function deleteProduct(id) {
             if(confirm('Eliminar?')) {
                 await fetch(`${API_URL}/catalog/products/${id}`, { method: 'DELETE' });
                 loadProducts();
             }
        }
        function initDashboard() { nav('dashboard'); }
        
        // --- ORDERS ---
        async function loadOrders() {
            const container = document.getElementById('orders-list');
            container.innerHTML = '<p class="text-center py-4">Cargando pedidos...</p>';
            try {
                const res = await fetch(`${API_URL}/orders`);
                const orders = await res.json();
                
                if (orders.length === 0) {
                    container.innerHTML = '<p class="text-center text-slate-500 py-4">No hay pedidos registrados.</p>';
                    return;
                }

                let html = `
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 border-b">
                            <tr>
                                <th class="px-6 py-4">ID Pedido</th>
                                <th class="px-6 py-4">Usuario (ID)</th>
                                <th class="px-6 py-4">Fecha</th>
                                <th class="px-6 py-4">Total</th>
                                <th class="px-6 py-4">Estado</th>
                                <th class="px-6 py-4">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                `;
                
                orders.forEach(o => {
                    html += `
                        <tr class="hover:bg-slate-50">
                            <td class="px-6 py-4 font-mono text-xs">${o.id}</td>
                            <td class="px-6 py-4 font-mono text-xs">${o.user_id}</td>
                            <td class="px-6 py-4">${new Date(o.created_at).toLocaleDateString()}</td>
                            <td class="px-6 py-4 font-bold">$${parseFloat(o.total).toFixed(2)}</td>
                            <td class="px-6 py-4"><span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-bold">${o.status}</span></td>
                            <td class="px-6 py-4">
                                <button onclick="alert('Detalles del pedido: ' + '${o.id}')" class="text-blue-600 hover:underline">Ver Detalles</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = '<p class="text-center text-red-500">Error cargando pedidos</p>';
            }
        }
        
        // --- INVENTORY MATRIX ---
        async function loadInventoryMatrix() {
            try {
                const [products, stocks, stores] = await Promise.all([
                    fetch(`${API_URL}/catalog/products`).then(r=>r.json()),
                    fetch(`${API_URL}/inventory/stock`).then(r=>r.json()),
                    fetch(`${API_URL}/inventory/stores`).then(r=>r.json())
                ]);
                
                let html = `<table class="w-full text-sm"><thead class="bg-slate-100"><tr><th>Producto</th>`;
                stores.forEach(s => html += `<th>${s.name}</th>`);
                html += `</tr></thead><tbody>`;
                
                products.forEach(p => {
                    html += `<tr class="border-b"><td class="p-2">${p.name}</td>`;
                    stores.forEach(s => {
                        const entry = stocks.find(k => k.product_id === p.id && k.store_id === s.id);
                        html += `<td class="p-2 text-center">${entry ? entry.quantity : 0}</td>`;
                    });
                    html += `</tr>`;
                });
                html += `</tbody></table>`;
                document.getElementById('inventory-matrix').innerHTML = html;
            } catch(e) {
                 document.getElementById('inventory-matrix').innerHTML = '<p>Error cargando inventario</p>';
            }
        }
    </script>
</body>
</html>